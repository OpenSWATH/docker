name: build-singularity

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      source_tag:
        description: "GHCR image tag to convert (e.g., v0.3.0, latest, sha-abcdef1)"
        required: true
        default: "latest"
      release_tag:
        description: "GitHub Release tag to upload SIF to (leave blank to skip)"
        required: false
        default: ""

  # Automatic trigger from the Docker workflow
  repository_dispatch:
    types: [singularity_build]

permissions:
  contents: write

jobs:
  sif:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      IMAGE_OWNER: openswath
      IMAGE_NAME: openswath
    steps:
      - uses: actions/checkout@v4

      - name: Set up Apptainer
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: '1.3.4'

      - name: Work out source tag
        id: tag
        run: |
          # Prefer repository_dispatch payload, then manual input, then 'latest'
          SRC_TAG="${{ github.event.client_payload.source_tag }}"
          if [ -z "$SRC_TAG" ]; then
            SRC_TAG="${{ github.event.inputs.source_tag }}"
          fi
          if [ -z "$SRC_TAG" ]; then
            SRC_TAG="latest"
          fi
          SAFE_TAG="${SRC_TAG//\//_}"
          echo "SRC_TAG=$SRC_TAG" >> $GITHUB_ENV
          echo "SIF=openswath-${SAFE_TAG}.sif" >> $GITHUB_ENV

      - name: Build SIF from GHCR (public image)
        env:
          APPTAINER_REMOTE: cloud.sylabs.io
          APPTAINER_TOKEN: ${{ secrets.SYLABS_TOKEN }}  # required for --remote
        run: |
          SRC="docker://${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:${{ env.SRC_TAG }}"
          echo "Building ${{ env.SIF }} from $SRC"
          apptainer build --remote "${{ env.SIF }}" "$SRC"
          ls -lh "${{ env.SIF }}"

      - name: Upload SIF as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SIF }}
          path: ${{ env.SIF }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload SIF to GitHub Release (optional for manual runs)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          files: ${{ env.SIF }}
